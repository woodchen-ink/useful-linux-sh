name: Create Release

on:
  push:
    tags:
      - 'v*'      # è§¦å‘æ¡ä»¶ï¼šæ¨é€ä»¥ v å¼€å¤´çš„æ ‡ç­¾ (å¦‚ v1.1, v1.2.0)
      - '[0-9]*'  # ä¹Ÿæ”¯æŒçº¯æ•°å­—æ ¼å¼çš„æ ‡ç­¾ (å¦‚ 1.4, 1.5)

permissions:
  contents: write  # å…è®¸åˆ›å»º release å’Œä¸Šä¼ æ–‡ä»¶

jobs:
  create-release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate scripts syntax
      run: |
        echo "ğŸ” æ£€æŸ¥æ‰€æœ‰è„šæœ¬è¯­æ³•..."
        bash -n uls.sh
        bash -n scripts/*/*.sh
        echo "âœ… æ‰€æœ‰è„šæœ¬è¯­æ³•æ£€æŸ¥é€šè¿‡"

    - name: Extract version from tag
      id: version
      run: |
        # ä»tagä¸­æå–ç‰ˆæœ¬å· (å…¼å®¹ v1.4 å’Œ 1.4 ä¸¤ç§æ ¼å¼)
        VERSION=${GITHUB_REF#refs/tags/}
        VERSION=${VERSION#v}  # å»æ‰å¯èƒ½çš„ v å‰ç¼€
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ“¦ Release version: $VERSION"

    - name: Update version in uls.sh
      run: |
        # æ›´æ–°uls.shä¸­çš„ç‰ˆæœ¬å·
        sed -i 's/SCRIPT_VERSION="[^"]*"/SCRIPT_VERSION="${{ steps.version.outputs.version }}"/' uls.sh
        sed -i 's/# ç‰ˆæœ¬: [0-9.]*/# ç‰ˆæœ¬: ${{ steps.version.outputs.version }}/' uls.sh
        echo "âœ… å·²æ›´æ–°uls.shç‰ˆæœ¬å·ä¸º ${{ steps.version.outputs.version }}"

    - name: Verify version update
      run: |
        echo "ğŸ” éªŒè¯ç‰ˆæœ¬æ›´æ–°..."
        grep "SCRIPT_VERSION=" uls.sh
        grep "# ç‰ˆæœ¬:" uls.sh

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: ULS v${{ steps.version.outputs.version }}
        body: |
          ## ULS (Useful Linux Scripts) v${{ steps.version.outputs.version }}

          ### ğŸš€ å¿«é€Ÿä½¿ç”¨
          ```bash
          curl -fsSL https://raw.githubusercontent.com/woodchen-ink/useful-linux-sh/refs/heads/main/uls.sh -o uls.sh
          chmod +x uls.sh
          sudo ./uls.sh
          ```

          ### ğŸ“‹ åŠŸèƒ½ç‰¹æ€§
          - ğŸ”„ Swapç©ºé—´ç®¡ç† - ä¸€é”®æ·»åŠ swapç©ºé—´
          - ğŸš€ BBR TCPä¼˜åŒ– - å¯ç”¨BBRæ‹¥å¡æ§åˆ¶ç®—æ³•
          - ğŸ›¡ï¸ UFWé˜²ç«å¢™é…ç½® - é…ç½®UFWé˜²ç«å¢™è§„åˆ™
          - ğŸš« Fail2bané˜²æŠ¤ - å®‰è£…é…ç½®å…¥ä¾µé˜²æŠ¤
          - ğŸŒ DNSé…ç½®é”å®š - è®¾ç½®å¹¶é”å®šDNSæœåŠ¡å™¨

          ### âœ¨ æ›´æ–°å†…å®¹
          - æ¯æ¬¡æ‰§è¡Œéƒ½ä¸‹è½½æœ€æ–°è„šæœ¬ç‰ˆæœ¬
          - åŸºäºGitHub Releaseçš„è‡ªåŠ¨ç‰ˆæœ¬ç®¡ç†
          - æ”¹è¿›çš„é”™è¯¯å¤„ç†å’Œç”¨æˆ·ä½“éªŒ

          ### ğŸ“¥ ä¸‹è½½æ–‡ä»¶
          - `uls.sh` - ULSä¸»ç®¡ç†è„šæœ¬

          å®Œæ•´æ–‡æ¡£è¯·æŸ¥çœ‹: https://github.com/woodchen-ink/useful-linux-sh
        draft: false
        prerelease: false

    - name: Upload ULS Script
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./uls.sh
        asset_name: uls.sh
        asset_content_type: application/x-sh

    - name: Commit version update
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add uls.sh
        git commit -m "chore: update version to ${{ steps.version.outputs.version }}" || exit 0
        git push origin HEAD:main || echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œå¯èƒ½æ˜¯æƒé™é—®é¢˜"

    - name: Release Summary
      run: |
        echo "ğŸ‰ Releaseåˆ›å»ºå®Œæˆ!"
        echo "ğŸ“¦ ç‰ˆæœ¬: v${{ steps.version.outputs.version }}"
        echo "ğŸ”— Release URL: ${{ steps.create_release.outputs.html_url }}"
        echo "ğŸ“ ä¸‹è½½åœ°å€: ${{ steps.create_release.outputs.upload_url }}"