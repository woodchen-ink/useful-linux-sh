name: Test Scripts

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  syntax-check:
    runs-on: ubuntu-latest
    name: Syntax Check

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check ULS script syntax
      run: |
        echo "ğŸ” æ£€æŸ¥ULSä¸»è„šæœ¬è¯­æ³•..."
        bash -n uls.sh
        echo "âœ… uls.sh è¯­æ³•æ£€æŸ¥é€šè¿‡"

    - name: Check all scripts syntax
      run: |
        echo "ğŸ” æ£€æŸ¥æ‰€æœ‰åŠŸèƒ½è„šæœ¬è¯­æ³•..."
        for script in scripts/*/*.sh; do
          if [ -f "$script" ]; then
            echo "æ£€æŸ¥: $script"
            bash -n "$script"
            echo "âœ… $script è¯­æ³•æ£€æŸ¥é€šè¿‡"
          fi
        done
        echo "ğŸ‰ æ‰€æœ‰è„šæœ¬è¯­æ³•æ£€æŸ¥å®Œæˆ"

    - name: Check for common issues
      run: |
        echo "ğŸ” æ£€æŸ¥å¸¸è§é—®é¢˜..."

        # æ£€æŸ¥æ˜¯å¦æœ‰åµŒå¥—çš„EOFæ ‡è®°
        echo "æ£€æŸ¥åµŒå¥—EOFæ ‡è®°..."
        if grep -r "EOF.*EOF" scripts/; then
          echo "âŒ å‘ç°åµŒå¥—çš„EOFæ ‡è®°"
          exit 1
        fi
        echo "âœ… æ²¡æœ‰åµŒå¥—EOFæ ‡è®°é—®é¢˜"

        # æ£€æŸ¥è„šæœ¬æƒé™æ ‡è®°
        echo "æ£€æŸ¥è„šæœ¬shebang..."
        for script in uls.sh scripts/*/*.sh; do
          if [ -f "$script" ] && ! head -n1 "$script" | grep -q "^#!/bin/bash"; then
            echo "âŒ $script ç¼ºå°‘æ­£ç¡®çš„shebang"
            exit 1
          fi
        done
        echo "âœ… æ‰€æœ‰è„šæœ¬éƒ½æœ‰æ­£ç¡®çš„shebang"

  functionality-test:
    runs-on: ubuntu-latest
    name: Basic Functionality Test

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Test ULS help and version
      run: |
        echo "ğŸ” æµ‹è¯•ULSåŸºæœ¬åŠŸèƒ½..."

        # æµ‹è¯•ç‰ˆæœ¬æ˜¾ç¤º
        bash uls.sh --version

        # æµ‹è¯•å¸®åŠ©ä¿¡æ¯
        bash uls.sh --help

        # æµ‹è¯•ä¿¡æ¯æ˜¾ç¤º
        bash uls.sh --info

        echo "âœ… ULSåŸºæœ¬åŠŸèƒ½æµ‹è¯•é€šè¿‡"

    - name: Test script download URLs
      run: |
        echo "ğŸ” æµ‹è¯•è„šæœ¬ä¸‹è½½URL..."

        # æµ‹è¯•ä¸»è¦è„šæœ¬æ–‡ä»¶æ˜¯å¦å¯è®¿é—®
        scripts=(
          "scripts/system/add-swap.sh"
          "scripts/system/enable_bbr.sh"
          "scripts/security/setup_ufw.sh"
          "scripts/security/setup_fail2ban.sh"
          "scripts/network/setup_dns.sh"
        )

        base_url="https://raw.githubusercontent.com/woodchen-ink/useful-linux-sh/refs/heads/main"

        for script in "${scripts[@]}"; do
          url="$base_url/$script"
          echo "æ£€æŸ¥: $url"
          if curl -f -s -I "$url" > /dev/null; then
            echo "âœ… $script å¯è®¿é—®"
          else
            echo "âŒ $script æ— æ³•è®¿é—®"
            exit 1
          fi
        done

        echo "ğŸ‰ æ‰€æœ‰è„šæœ¬URLæµ‹è¯•é€šè¿‡"